name: Aspire Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: bethmassi/volumemount
  DOTNET_ASPIRE_ENABLE_DEPLOY_COMMAND: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install Aspire workload
        run: dotnet workload install aspire

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Install Aspire CLI
        run: dotnet tool install --global aspire.cli --prerelease

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Docker Compose with Aspire
        id: aspire_build
        run: |
          # Use Aspire CLI to prepare Docker Compose files and build container images
          # This generates docker-compose.yml and builds all service images
          aspire do prepare-compose --environment production \
            --project VolumeMount.AppHost/VolumeMount.AppHost.csproj \
            --output-path ./aspire-output

      - name: Display generated Docker Compose
        run: |
          echo "Contents of aspire-output directory:"
          ls -la ./aspire-output/ || echo "aspire-output directory not found"

          if [ -f ./aspire-output/docker-compose.yml ]; then
            echo ""
            echo "Generated Docker Compose file:"
            cat ./aspire-output/docker-compose.yml
          elif [ -f ./aspire-output/docker-compose.yaml ]; then
            echo ""
            echo "Generated Docker Compose file:"
            cat ./aspire-output/docker-compose.yaml
          else
            echo ""
            echo "Docker Compose file not found. Searching..."
            find ./aspire-output -name "*.yml" -o -name "*.yaml" 2>/dev/null || echo "No YAML files found"
          fi

      - name: Extract image tags
        id: extract_tags
        run: |
          # Get short SHA (first 7 characters)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          # Extract branch name or use 'main' as default
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # For pull requests, use the head ref
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME=${{ github.head_ref }}
          fi

          # Create tags list
          TAGS="latest,${BRANCH_NAME},${SHORT_SHA}"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Tag and push images to GHCR
        run: |
          SHORT_SHA=${{ steps.extract_tags.outputs.short_sha }}
          BRANCH_NAME=${{ steps.extract_tags.outputs.branch_name }}

          # Find the blazorweb image built by Aspire
          # Aspire typically tags images with project name in lowercase
          ASPIRE_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -i blazorweb | head -1)

          if [ -z "$ASPIRE_IMAGE" ]; then
            echo "Error: Could not find blazorweb image built by Aspire"
            docker images
            exit 1
          fi

          echo "Found Aspire-built image: $ASPIRE_IMAGE"

          # Tag for GHCR with latest tag
          docker tag $ASPIRE_IMAGE ghcr.io/bethmassi/volumemount/blazorweb:latest
          docker push ghcr.io/bethmassi/volumemount/blazorweb:latest

          # Get image digest from the pushed image
          IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/bethmassi/volumemount/blazorweb:latest | cut -d'@' -f2)
          echo "image_digest=${IMAGE_DIGEST}" >> $GITHUB_OUTPUT

          # Tag with branch name and short SHA
          docker tag ghcr.io/bethmassi/volumemount/blazorweb:latest \
            ghcr.io/bethmassi/volumemount/blazorweb:${BRANCH_NAME}
          docker tag ghcr.io/bethmassi/volumemount/blazorweb:latest \
            ghcr.io/bethmassi/volumemount/blazorweb:${SHORT_SHA}

          # Push all tags
          docker push ghcr.io/bethmassi/volumemount/blazorweb:${BRANCH_NAME}
          docker push ghcr.io/bethmassi/volumemount/blazorweb:${SHORT_SHA}
        id: tag_images

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        continue-on-error: true
        with:
          subject-name: ghcr.io/bethmassi/volumemount/blazorweb
          subject-digest: ${{ steps.tag_images.outputs.image_digest }}
          push-to-registry: true

      - name: Upload Docker Compose artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aspire-docker-compose
          path: ./aspire-output/
          retention-days: 30
        continue-on-error: true

      - name: Output deployment summary
        run: |
          SHORT_SHA=${{ steps.extract_tags.outputs.short_sha }}
          BRANCH_NAME=${{ steps.extract_tags.outputs.branch_name }}

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Deployment Summary

          ## Published Images

          | Image | Tags |
          |-------|------|
          | ghcr.io/bethmassi/volumemount/blazorweb | latest, ${BRANCH_NAME}, ${SHORT_SHA} |

          ## Docker Commands

          ### Pull Image
          \`\`\`bash
          docker pull ghcr.io/bethmassi/volumemount/blazorweb:latest
          \`\`\`

          ### Run Container
          \`\`\`bash
          docker run -d -p 8080:8080 ghcr.io/bethmassi/volumemount/blazorweb:latest
          \`\`\`
          EOF
